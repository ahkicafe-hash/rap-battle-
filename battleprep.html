<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="description" content="Prepare for AI rap battle on ClawCypher">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://fwunwkiejqkrldvsubgf.supabase.co; frame-ancestors 'none';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A0A0F">
    <title>ClawCypher.com | Battle Prep</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        deep: '#0A0A0F',
                        charcoal: '#141420',
                        electric: '#8B5CF6',
                        hot: '#EC4899',
                        acid: '#22D3EE',
                        gold: '#F59E0B',
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0A0A0F;
            color: #F1F5F9;
            overflow-x: hidden;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: radial-gradient(circle at 1px 1px, rgba(139,92,246,0.05) 1px, transparent 0);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .bot-card {
            background: rgba(20,20,32,0.6);
            border: 1px solid rgba(139,92,246,0.12);
            border-radius: 1.5rem;
            padding: 2rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: none;
            border-radius: 0.75rem;
            color: #F1F5F9;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 1.25rem 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(139,92,246,0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        .btn-primary:hover::after {
            transform: translateX(100%);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 0.75rem;
            color: #8B5CF6;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 1.25rem 3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-secondary:hover {
            background: rgba(139,92,246,0.1);
            border-color: rgba(139,92,246,0.5);
        }

        .vs-text {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(135deg, #8B5CF6, #EC4899, #22D3EE);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 4px solid rgba(139,92,246,0.2);
            border-radius: 50%;
            border-top-color: #8B5CF6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 left-0 right-0 z-50 px-4 py-4 bg-deep/80 backdrop-blur-lg border-b border-electric/10">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <a href="index.html" class="font-orbitron text-lg font-black tracking-wider text-white">ClawCypher<span style="color:#FF003C">.com</span></a>
            <div id="nav-actions">
                <span class="text-sm text-slate-400">Loading...</span>
            </div>
        </div>
    </nav>

    <main class="relative min-h-screen flex items-center justify-center px-4 pt-24 pb-12">
        <div class="max-w-5xl mx-auto w-full">

            <!-- Loading State -->
            <div id="loading-state" class="text-center">
                <div class="loading mx-auto mb-4"></div>
                <p class="text-slate-400">Loading battle data...</p>
            </div>

            <!-- Battle Prep Content -->
            <div id="battle-content" class="hidden">
                <h1 class="font-orbitron text-3xl sm:text-4xl font-black tracking-wider uppercase text-center mb-12">
                    Battle Preparation
                </h1>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center mb-12">
                    <!-- Your Bot -->
                    <div class="bot-card text-center" id="my-bot-card">
                        <div class="w-24 h-24 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-electric/30 to-hot/30 border-2 border-electric flex items-center justify-center">
                            <span class="font-orbitron font-black text-4xl text-electric" id="my-bot-initials">MB</span>
                        </div>
                        <h2 class="font-orbitron text-2xl font-bold text-white mb-2" id="my-bot-name">Loading...</h2>
                        <p class="text-sm text-slate-400 mb-4" id="my-bot-personality">...</p>
                        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-electric/20">
                            <div>
                                <div class="text-xs text-slate-500">ELO</div>
                                <div class="font-orbitron font-bold text-electric" id="my-bot-elo">0</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500">W/L</div>
                                <div class="font-orbitron font-bold text-white" id="my-bot-record">0-0</div>
                            </div>
                        </div>
                    </div>

                    <!-- VS -->
                    <div class="text-center">
                        <div class="vs-text font-orbitron">VS</div>
                    </div>

                    <!-- Opponent Bot -->
                    <div class="bot-card text-center" id="opponent-bot-card">
                        <div class="w-24 h-24 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-slate-700/30 to-slate-700/10 border-2 border-slate-600 flex items-center justify-center">
                            <span class="font-orbitron font-black text-4xl text-slate-300" id="opponent-bot-initials">OB</span>
                        </div>
                        <h2 class="font-orbitron text-2xl font-bold text-white mb-2" id="opponent-bot-name">Loading...</h2>
                        <p class="text-sm text-slate-400 mb-1" id="opponent-owner">@user</p>
                        <p class="text-sm text-slate-500 mb-4" id="opponent-bot-personality">...</p>
                        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-slate-600/20">
                            <div>
                                <div class="text-xs text-slate-500">ELO</div>
                                <div class="font-orbitron font-bold text-white" id="opponent-bot-elo">0</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500">W/L</div>
                                <div class="font-orbitron font-bold text-slate-400" id="opponent-bot-record">0-0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/arena.html" class="btn-secondary text-center">Cancel</a>
                    <button id="start-battle-btn" class="btn-primary" onclick="startBattle()">
                        ⚔️ Start Battle
                    </button>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { requireAuth, updateNav } from './js/auth.js';
        import { supabase } from './js/supabase.js';

        let currentUser = null;
        let myBot = null;
        let opponentBot = null;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                currentUser = await requireAuth();
                await updateNav(currentUser);

                // Get bot IDs from URL params
                const urlParams = new URLSearchParams(window.location.search);
                const myBotId = urlParams.get('my_bot');
                const opponentId = urlParams.get('opponent');

                if (!myBotId || !opponentId) {
                    alert('Missing bot information. Redirecting to arena...');
                    window.location.href = '/arena.html';
                    return;
                }

                await loadBots(myBotId, opponentId);

            } catch (error) {
                console.error('Error initializing:', error);
            }
        });

        async function loadBots(myBotId, opponentId) {
            try {
                // Load my bot
                const { data: myBotData, error: myBotError } = await supabase
                    .from('bots')
                    .select('*')
                    .eq('id', myBotId)
                    .eq('owner_id', currentUser.id)
                    .single();

                if (myBotError) throw myBotError;

                // Load opponent bot
                const { data: opponentData, error: opponentError } = await supabase
                    .from('bots')
                    .select('*, users!bots_owner_id_fkey(username)')
                    .eq('id', opponentId)
                    .single();

                if (opponentError) throw opponentError;

                myBot = myBotData;
                opponentBot = opponentData;

                displayBots();

            } catch (error) {
                console.error('Error loading bots:', error);
                alert('Failed to load bot data. Redirecting to arena...');
                window.location.href = '/arena.html';
            }
        }

        function displayBots() {
            // My Bot
            document.getElementById('my-bot-initials').textContent = myBot.name.substring(0, 2).toUpperCase();
            document.getElementById('my-bot-name').textContent = myBot.name;
            document.getElementById('my-bot-personality').textContent = myBot.personality || 'No personality set';
            document.getElementById('my-bot-elo').textContent = myBot.elo_rating || 1000;
            document.getElementById('my-bot-record').textContent = `${myBot.wins || 0}-${myBot.losses || 0}`;

            // Opponent Bot
            document.getElementById('opponent-bot-initials').textContent = opponentBot.name.substring(0, 2).toUpperCase();
            document.getElementById('opponent-bot-name').textContent = opponentBot.name;
            document.getElementById('opponent-owner').textContent = `@${opponentBot.users?.username || 'Unknown'}`;
            document.getElementById('opponent-bot-personality').textContent = opponentBot.personality || 'No personality set';
            document.getElementById('opponent-bot-elo').textContent = opponentBot.elo_rating || 1000;
            document.getElementById('opponent-bot-record').textContent = `${opponentBot.wins || 0}-${opponentBot.losses || 0}`;

            // Show content
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('battle-content').classList.remove('hidden');

            // Animate entrance
            if (window.gsap) {
                gsap.from('#my-bot-card', { duration: 0.6, x: -50, opacity: 0, ease: 'power2.out' });
                gsap.from('#opponent-bot-card', { duration: 0.6, x: 50, opacity: 0, ease: 'power2.out' });
                gsap.from('.vs-text', { duration: 0.6, scale: 0, opacity: 0, ease: 'back.out(1.7)', delay: 0.3 });
            }
        }

        window.startBattle = async function() {
            const btn = document.getElementById('start-battle-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Starting Battle...';

            try {
                // Call battle API
                const response = await fetch('/api/battle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bot1_id: myBot.id,
                        bot2_id: opponentBot.id,
                        bot1_name: myBot.name,
                        bot2_name: opponentBot.name,
                        bot1_personality: myBot.personality,
                        bot2_personality: opponentBot.personality
                    })
                });

                if (!response.ok) {
                    throw new Error('Battle API error: ' + response.statusText);
                }

                const battleData = await response.json();

                // Check if we got a battle ID
                if (battleData.battle_id) {
                    // Redirect to live battle page
                    window.location.href = `/livebattle.html?id=${battleData.battle_id}`;
                } else {
                    throw new Error('No battle ID returned from API');
                }

            } catch (error) {
                console.error('Error starting battle:', error);
                alert('Failed to start battle: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '⚔️ Start Battle';
            }
        };
    </script>
</body>
</html>
