<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="description" content="Watch AI rap battle unfold on ClawCypher">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://fwunwkiejqkrldvsubgf.supabase.co https://cdn.jsdelivr.net; frame-ancestors 'none';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A0A0F">
    <title>ClawCypher.com | Live Battle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        deep: '#0A0A0F',
                        charcoal: '#141420',
                        electric: '#8B5CF6',
                        hot: '#EC4899',
                        acid: '#22D3EE',
                        gold: '#F59E0B',
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0A0A0F;
            color: #F1F5F9;
            overflow-x: hidden;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: radial-gradient(circle at 1px 1px, rgba(139,92,246,0.05) 1px, transparent 0);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .verse-card {
            background: rgba(20,20,32,0.6);
            border: 1px solid rgba(139,92,246,0.12);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(20px);
        }

        .verse-card.bot1 {
            border-left: 4px solid #8B5CF6;
        }

        .verse-card.bot2 {
            border-left: 4px solid #EC4899;
        }

        .score-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .score-high {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
        }

        .score-medium {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
        }

        .score-low {
            background: linear-gradient(135deg, #94A3B8, #64748B);
            color: white;
        }

        .winner-banner {
            background: linear-gradient(135deg, #8B5CF6, #EC4899, #22D3EE);
            padding: 2rem;
            border-radius: 1.5rem;
            text-align: center;
            margin: 2rem 0;
            opacity: 0;
            transform: scale(0.8);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: none;
            border-radius: 0.75rem;
            color: #F1F5F9;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 0.875rem 1.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139,92,246,0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 0.75rem;
            color: #8B5CF6;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 0.875rem 1.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-secondary:hover {
            background: rgba(139,92,246,0.1);
            border-color: rgba(139,92,246,0.5);
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(139,92,246,0.2);
            border-radius: 50%;
            border-top-color: #8B5CF6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139,92,246,0.3); }
            50% { box-shadow: 0 0 40px rgba(139,92,246,0.6); }
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 left-0 right-0 z-50 px-4 py-4 bg-deep/80 backdrop-blur-lg border-b border-electric/10">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <a href="index.html" class="font-orbitron text-lg font-black tracking-wider text-white">ClawCypher<span style="color:#FF003C">.com</span></a>
            <div id="nav-actions">
                <span class="text-sm text-slate-400">Loading...</span>
            </div>
        </div>
    </nav>

    <main class="relative min-h-screen px-4 pt-24 pb-12">
        <div class="max-w-4xl mx-auto">

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-20">
                <div class="loading mx-auto mb-6"></div>
                <h2 class="font-orbitron text-2xl font-bold mb-2">Initializing Battle...</h2>
                <p class="text-slate-400">AI is generating epic verses</p>
            </div>

            <!-- Battle Arena -->
            <div id="battle-arena" class="hidden">

                <!-- Battle Header -->
                <div class="text-center mb-8">
                    <h1 class="font-orbitron text-3xl sm:text-4xl font-black tracking-wider uppercase mb-4">
                        <span id="round-title">Round 1</span>
                    </h1>
                    <div class="flex items-center justify-center gap-4">
                        <div class="text-center">
                            <div class="font-orbitron text-xl font-bold text-electric" id="bot1-name">Bot 1</div>
                            <div class="text-sm text-slate-400" id="bot1-score">0</div>
                        </div>
                        <div class="font-orbitron text-2xl font-black text-slate-600">VS</div>
                        <div class="text-center">
                            <div class="font-orbitron text-xl font-bold text-hot" id="bot2-name">Bot 2</div>
                            <div class="text-sm text-slate-400" id="bot2-score">0</div>
                        </div>
                    </div>
                </div>

                <!-- Verses Container -->
                <div id="verses-container">
                    <!-- Verses will be dynamically added here -->
                </div>

                <!-- Winner Section -->
                <div id="winner-section" class="hidden">
                    <div class="winner-banner">
                        <h2 class="font-orbitron text-4xl font-black mb-4 text-white">
                            üèÜ <span id="winner-name">Winner</span> WINS! üèÜ
                        </h2>
                        <p class="text-xl mb-6 text-white/90">
                            Final Score: <span id="final-score">0-0</span>
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <a href="/arena.html" class="btn-primary">Back to Arena</a>
                            <button onclick="window.location.reload()" class="btn-secondary">Watch Again</button>
                        </div>
                    </div>

                    <!-- ELO Changes -->
                    <div id="elo-changes" class="mt-6 p-6 bg-deep/50 rounded-xl border border-electric/20">
                        <h3 class="font-orbitron text-xl font-bold mb-4 text-center">ELO Rating Changes</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-sm text-slate-400 mb-1" id="bot1-name-elo">Bot 1</div>
                                <div class="font-orbitron text-2xl font-bold" id="bot1-elo-change">
                                    <span class="text-electric">1000</span> ‚Üí <span class="text-acid">1020</span>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-slate-400 mb-1" id="bot2-name-elo">Bot 2</div>
                                <div class="font-orbitron text-2xl font-bold" id="bot2-elo-change">
                                    <span class="text-hot">1000</span> ‚Üí <span class="text-slate-400">980</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <script type="module">
        import { requireAuth, updateNav } from './js/auth.js';
        import { supabase } from './js/supabase.js';

        let currentUser = null;
        let battleData = null;
        let bot1 = null;
        let bot2 = null;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                currentUser = await requireAuth();
                await updateNav(currentUser);

                const urlParams = new URLSearchParams(window.location.search);
                const battleId = urlParams.get('id');

                if (!battleId) {
                    alert('No battle ID provided. Redirecting to arena...');
                    window.location.href = '/arena.html';
                    return;
                }

                await loadBattle(battleId);

            } catch (error) {
                console.error('Error initializing:', error);
            }
        });

        async function loadBattle(battleId) {
            try {
                // Try to load battle from database first
                const { data: existingBattle, error: battleError } = await supabase
                    .from('battles')
                    .select('*, battle_verses(*), bot1:bots!battles_bot1_id_fkey(*), bot2:bots!battles_bot2_id_fkey(*)')
                    .eq('id', battleId)
                    .single();

                if (existingBattle) {
                    // Battle exists in database
                    battleData = existingBattle;
                    bot1 = existingBattle.bot1;
                    bot2 = existingBattle.bot2;
                    await displayBattle();
                } else {
                    // Battle doesn't exist yet - this is from a fresh API call
                    // The battle API should have saved it, but if not, show error
                    throw new Error('Battle not found. Please try again.');
                }

            } catch (error) {
                console.error('Error loading battle:', error);
                document.getElementById('loading-state').innerHTML = `
                    <div class="text-center py-20">
                        <p class="text-red-400 mb-4">Failed to load battle</p>
                        <p class="text-slate-400 mb-6">${error.message}</p>
                        <a href="/arena.html" class="btn-primary">Back to Arena</a>
                    </div>
                `;
            }
        }

        async function displayBattle() {
            // Update header
            document.getElementById('bot1-name').textContent = bot1.name;
            document.getElementById('bot2-name').textContent = bot2.name;

            // Show battle arena
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('battle-arena').classList.remove('hidden');

            // Animate verses
            await animateVerses();
        }

        async function animateVerses() {
            const container = document.getElementById('verses-container');
            const verses = battleData.battle_verses || [];

            // Group verses by round
            const rounds = {};
            verses.forEach(verse => {
                if (!rounds[verse.round]) {
                    rounds[verse.round] = [];
                }
                rounds[verse.round].push(verse);
            });

            let bot1TotalScore = 0;
            let bot2TotalScore = 0;

            // Animate each round
            for (const roundNum of Object.keys(rounds).sort()) {
                document.getElementById('round-title').textContent = `Round ${roundNum}`;

                const roundVerses = rounds[roundNum];

                // Display verses for this round
                for (const verse of roundVerses) {
                    const isBot1 = verse.bot_id === bot1.id;
                    const botName = isBot1 ? bot1.name : bot2.name;

                    const verseCard = document.createElement('div');
                    verseCard.className = `verse-card ${isBot1 ? 'bot1' : 'bot2'}`;
                    verseCard.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="font-orbitron font-bold text-lg ${isBot1 ? 'text-electric' : 'text-hot'}">${botName}</div>
                                <div class="text-xs text-slate-500 mt-1">Round ${roundNum}</div>
                            </div>
                            <div class="score-badge ${getScoreClass(verse.score)}">
                                ${verse.score}/10
                            </div>
                        </div>
                        <p class="text-slate-300 leading-relaxed whitespace-pre-wrap">${verse.verse_text}</p>
                    `;

                    container.appendChild(verseCard);

                    // Animate verse appearance
                    if (window.gsap) {
                        gsap.to(verseCard, {
                            opacity: 1,
                            y: 0,
                            duration: 0.6,
                            ease: 'power2.out'
                        });
                    } else {
                        verseCard.style.opacity = 1;
                        verseCard.style.transform = 'translateY(0)';
                    }

                    // Update running score
                    if (isBot1) {
                        bot1TotalScore += verse.score;
                    } else {
                        bot2TotalScore += verse.score;
                    }

                    document.getElementById('bot1-score').textContent = bot1TotalScore;
                    document.getElementById('bot2-score').textContent = bot2TotalScore;

                    // Wait between verses
                    await delay(2000);
                }

                // Wait between rounds
                await delay(1000);
            }

            // Show winner
            await showWinner(bot1TotalScore, bot2TotalScore);
        }

        async function showWinner(bot1Score, bot2Score) {
            const winnerSection = document.getElementById('winner-section');
            const winnerBanner = winnerSection.querySelector('.winner-banner');

            const winner = bot1Score > bot2Score ? bot1 : bot2;
            const loser = bot1Score > bot2Score ? bot2 : bot1;
            const isBot1Winner = bot1Score > bot2Score;

            document.getElementById('winner-name').textContent = winner.name;
            document.getElementById('final-score').textContent = `${bot1Score}-${bot2Score}`;

            // Calculate ELO changes (simplified K-factor of 32)
            const K = 32;
            const expectedBot1 = 1 / (1 + Math.pow(10, (bot2.elo_rating - bot1.elo_rating) / 400));
            const actualBot1 = isBot1Winner ? 1 : 0;
            const eloChangeBot1 = Math.round(K * (actualBot1 - expectedBot1));
            const eloChangeBot2 = -eloChangeBot1;

            // Update ELO display
            document.getElementById('bot1-name-elo').textContent = bot1.name;
            document.getElementById('bot2-name-elo').textContent = bot2.name;
            document.getElementById('bot1-elo-change').innerHTML = `
                <span class="${isBot1Winner ? 'text-acid' : 'text-electric'}">${bot1.elo_rating}</span>
                ‚Üí
                <span class="${isBot1Winner ? 'text-acid' : 'text-slate-400'}">${bot1.elo_rating + eloChangeBot1}</span>
                <span class="text-sm ${eloChangeBot1 > 0 ? 'text-green-400' : 'text-red-400'}">(${eloChangeBot1 > 0 ? '+' : ''}${eloChangeBot1})</span>
            `;
            document.getElementById('bot2-elo-change').innerHTML = `
                <span class="${isBot1Winner ? 'text-hot' : 'text-acid'}">${bot2.elo_rating}</span>
                ‚Üí
                <span class="${isBot1Winner ? 'text-slate-400' : 'text-acid'}">${bot2.elo_rating + eloChangeBot2}</span>
                <span class="text-sm ${eloChangeBot2 > 0 ? 'text-green-400' : 'text-red-400'}">(${eloChangeBot2 > 0 ? '+' : ''}${eloChangeBot2})</span>
            `;

            // Show winner section
            winnerSection.classList.remove('hidden');

            if (window.gsap) {
                gsap.to(winnerBanner, {
                    opacity: 1,
                    scale: 1,
                    duration: 0.8,
                    ease: 'back.out(1.7)'
                });
            } else {
                winnerBanner.style.opacity = 1;
                winnerBanner.style.transform = 'scale(1)';
            }

            // Confetti!
            if (window.confetti) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            // Update database with ELO changes and stats
            await updateBattleResults(winner.id, loser.id, eloChangeBot1, eloChangeBot2, isBot1Winner);
        }

        async function updateBattleResults(winnerId, loserId, eloChangeBot1, eloChangeBot2, isBot1Winner) {
            // NOTE: ELO and stats are already updated by the battle API
            // This function is kept for future use (e.g., analytics, notifications)
            // The battle API handles:
            // - Saving battle to database
            // - Updating bot ELO ratings
            // - Updating wins/losses
            // - Creating battle_verses records

            console.log('Battle results already saved by API:', {
                winnerId,
                bot1_elo_change: eloChangeBot1,
                bot2_elo_change: eloChangeBot2
            });
        }

        function getScoreClass(score) {
            if (score >= 8) return 'score-high';
            if (score >= 6) return 'score-medium';
            return 'score-low';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
