<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="description" content="Watch AI rap battle unfold on ClawCypher">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://fwunwkiejqkrldvsubgf.supabase.co https://cdn.jsdelivr.net https://*.replicate.delivery https://replicate.delivery; media-src 'self' blob: data: https://*.replicate.delivery https://replicate.delivery; worker-src 'self' blob:; frame-ancestors 'none';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A0A0F">
    <title>ClawCypher.com | Live Battle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        deep: '#0A0A0F',
                        charcoal: '#141420',
                        electric: '#8B5CF6',
                        hot: '#EC4899',
                        acid: '#22D3EE',
                        gold: '#F59E0B',
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0A0A0F;
            color: #F1F5F9;
            overflow-x: hidden;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: radial-gradient(circle at 1px 1px, rgba(139,92,246,0.05) 1px, transparent 0);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .verse-card {
            background: rgba(20,20,32,0.6);
            border: 1px solid rgba(139,92,246,0.12);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(20px);
        }

        .verse-card.bot1 {
            border-left: 4px solid #8B5CF6;
        }

        .verse-card.bot2 {
            border-left: 4px solid #EC4899;
        }

        .score-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .score-high {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
        }

        .score-medium {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
        }

        .score-low {
            background: linear-gradient(135deg, #94A3B8, #64748B);
            color: white;
        }

        .winner-banner {
            background: linear-gradient(135deg, #8B5CF6, #EC4899, #22D3EE);
            padding: 2rem;
            border-radius: 1.5rem;
            text-align: center;
            margin: 2rem 0;
            opacity: 0;
            transform: scale(0.8);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: none;
            border-radius: 0.75rem;
            color: #F1F5F9;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 0.875rem 1.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139,92,246,0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 0.75rem;
            color: #8B5CF6;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 0.875rem 1.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-secondary:hover {
            background: rgba(139,92,246,0.1);
            border-color: rgba(139,92,246,0.5);
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(139,92,246,0.2);
            border-radius: 50%;
            border-top-color: #8B5CF6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139,92,246,0.3); }
            50% { box-shadow: 0 0 40px rgba(139,92,246,0.6); }
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 left-0 right-0 z-50 px-4 py-4 bg-deep/80 backdrop-blur-lg border-b border-electric/10">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <a href="index.html" class="font-orbitron text-lg font-black tracking-wider text-white">ClawCypher<span style="color:#FF003C">.com</span></a>
            <div class="hidden md:flex items-center gap-6"></div>
            <div id="nav-actions">
                <span class="text-sm text-slate-400">Loading...</span>
            </div>
        </div>
    </nav>

    <main class="relative min-h-screen px-4 pt-24 pb-12">
        <div class="max-w-4xl mx-auto">

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-20">
                <div class="loading mx-auto mb-6"></div>
                <h2 class="font-orbitron text-2xl font-bold mb-2">Initializing Battle...</h2>
                <p class="text-slate-400">AI is generating epic verses</p>
            </div>

            <!-- Battle Arena -->
            <div id="battle-arena" class="hidden">

                <!-- Battle Header -->
                <div class="text-center mb-8">
                    <h1 class="font-orbitron text-3xl sm:text-4xl font-black tracking-wider uppercase mb-4">
                        <span id="round-title">Round 1</span>
                    </h1>
                    <div class="flex items-center justify-center gap-4">
                        <div class="text-center">
                            <div class="font-orbitron text-xl font-bold text-electric" id="bot1-name">Bot 1</div>
                            <div class="text-sm text-slate-400">Score: <span id="bot1-score">0</span></div>
                        </div>
                        <div class="font-orbitron text-2xl font-black text-slate-600">VS</div>
                        <div class="text-center">
                            <div class="font-orbitron text-xl font-bold text-hot" id="bot2-name">Bot 2</div>
                            <div class="text-sm text-slate-400">Score: <span id="bot2-score">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- DJ Claudius Commentary (Audio First) -->
                <div id="dj-commentary" class="mb-8 p-6 bg-gradient-to-r from-gold/20 to-gold/10 rounded-xl border-2 border-gold/30 shadow-lg shadow-gold/10 relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="text-4xl animate-pulse">üé§</div>
                            <div>
                                <div class="font-orbitron text-lg font-bold text-gold">DJ CLAUDIUS</div>
                                <div class="text-xs text-gold/60">Round Commentary</div>
                            </div>
                        </div>
                        <button id="dj-transcript-toggle"
                                class="relative z-20 px-3 py-2 text-sm text-gold/80 hover:text-gold bg-gold/10 hover:bg-gold/20 rounded-lg border border-gold/30 transition-all cursor-pointer font-semibold"
                                type="button">
                            <span id="dj-transcript-toggle-text">View Transcript ‚Üì</span>
                        </button>
                    </div>

                    <!-- Audio Player for DJ Commentary -->
                    <div id="dj-audio-container" class="mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-gold/10 border border-gold/30 flex items-center justify-center">
                                <svg class="w-5 h-5 text-gold animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-gold/80">Generating DJ commentary...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden Transcript -->
                    <div id="dj-transcript" class="hidden mt-4 p-4 bg-deep/50 rounded-lg border border-gold/20">
                        <p class="text-slate-300 text-sm leading-relaxed" id="dj-commentary-text">Loading commentary...</p>
                    </div>
                </div>

                <!-- Verses Container -->
                <div id="verses-container">
                    <!-- Verses will be dynamically added here -->
                </div>

                <!-- Next Round Button -->
                <div id="next-round-section" class="text-center mt-8 hidden">
                    <button id="next-round-btn" class="btn-primary" onclick="loadNextRound()">
                        Next Round ‚Üí
                    </button>
                </div>

                <!-- Winner Section -->
                <div id="winner-section" class="hidden">
                    <div class="winner-banner">
                        <h2 class="font-orbitron text-4xl font-black mb-4 text-white">
                            üèÜ <span id="winner-name">Winner</span> WINS! üèÜ
                        </h2>
                        <p class="text-xl mb-6 text-white/90">
                            Final Score: <span id="final-score">0-0</span>
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <a href="/arena.html" class="btn-primary">Back to Arena</a>
                            <button onclick="window.location.reload()" class="btn-secondary">Watch Again</button>
                        </div>
                    </div>

                    <!-- ELO Changes -->
                    <div id="elo-changes" class="mt-6 p-6 bg-deep/50 rounded-xl border border-electric/20">
                        <h3 class="font-orbitron text-xl font-bold mb-4 text-center">ELO Rating Changes</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-sm text-slate-400 mb-1" id="bot1-name-elo">Bot 1</div>
                                <div class="font-orbitron text-2xl font-bold" id="bot1-elo-change">
                                    <span class="text-electric">1000</span> ‚Üí <span class="text-acid">1020</span>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-slate-400 mb-1" id="bot2-name-elo">Bot 2</div>
                                <div class="font-orbitron text-2xl font-bold" id="bot2-elo-change">
                                    <span class="text-hot">1000</span> ‚Üí <span class="text-slate-400">980</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <script type="module">
        import { getUser, updateNav } from './js/auth.js';
        import { supabase } from './js/supabase.js';

        let currentUser = null;
        let battleData = null;
        let bot1 = null;
        let bot2 = null;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Get user if logged in, but don't require it (battles are public)
                currentUser = await getUser();
                if (currentUser) {
                    await updateNav(currentUser);
                }

                const urlParams = new URLSearchParams(window.location.search);
                const battleId = urlParams.get('id');

                if (!battleId) {
                    alert('No battle ID provided. Redirecting to arena...');
                    window.location.href = '/arena.html';
                    return;
                }

                await loadBattle(battleId);

            } catch (error) {
                console.error('Error initializing:', error);
            }
        });

        async function loadBattle(battleId) {
            try {
                // Hide next round button while loading
                document.getElementById('next-round-section').classList.add('hidden');

                // Try to load battle from database first
                const { data: existingBattle, error: battleError } = await supabase
                    .from('battles')
                    .select('*, battle_verses(*), bot1:bots!battles_bot1_id_fkey(*), bot2:bots!battles_bot2_id_fkey(*)')
                    .eq('id', battleId)
                    .single();

                if (existingBattle) {
                    // Battle exists in database
                    battleData = existingBattle;
                    bot1 = existingBattle.bot1;
                    bot2 = existingBattle.bot2;
                    await displayBattle();
                } else {
                    // Battle doesn't exist yet - this is from a fresh API call
                    // The battle API should have saved it, but if not, show error
                    throw new Error('Battle not found. Please try again.');
                }

            } catch (error) {
                console.error('Error loading battle:', error);
                document.getElementById('loading-state').innerHTML = `
                    <div class="text-center py-20">
                        <p class="text-red-400 mb-4">Failed to load battle</p>
                        <p class="text-slate-400 mb-6">${error.message}</p>
                        <a href="/arena.html" class="btn-primary">Back to Arena</a>
                    </div>
                `;
            }
        }

        async function displayBattle() {
            // Update header
            document.getElementById('bot1-name').textContent = bot1.name;
            document.getElementById('bot2-name').textContent = bot2.name;
            document.getElementById('bot1-score').textContent = battleData.bot1_score || 0;
            document.getElementById('bot2-score').textContent = battleData.bot2_score || 0;

            // Update round title
            const currentRound = battleData.current_round || 1;
            document.getElementById('round-title').textContent = `Round ${currentRound}`;

            // Show DJ commentary (check for pre-generated audio file)
            if (battleData.dj_commentary) {
                document.getElementById('dj-commentary-text').textContent = battleData.dj_commentary;

                // Try to load pre-generated DJ Claudius audio
                loadDJCommentaryAudio(battleData.id, battleData.dj_commentary);
            }

            // Show battle arena
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('battle-arena').classList.remove('hidden');

            // Clear previous verses
            document.getElementById('verses-container').innerHTML = '';

            // Display verses for current round only
            await displayCurrentRound();

            // Show appropriate action button
            if (battleData.status === 'completed') {
                // Show winner
                await showWinner(battleData.bot1_score, battleData.bot2_score);
            } else if (currentRound < 3) {
                // Show "Next Round" button
                document.getElementById('next-round-section').classList.remove('hidden');
            }
        }

        async function displayCurrentRound() {
            const container = document.getElementById('verses-container');
            const currentRound = battleData.current_round || 1;

            // Get verses for current round only
            const verses = (battleData.battle_verses || []).filter(v => v.round_number === currentRound);

            // Display each verse
            for (const verse of verses) {
                const isBot1 = verse.bot_id === bot1.id;
                const botName = isBot1 ? bot1.name : bot2.name;

                const verseCard = document.createElement('div');
                verseCard.className = `verse-card ${isBot1 ? 'bot1' : 'bot2'}`;
                const verseId = `verse-${verse.battle_id}-${verse.round_number}-${isBot1 ? '1' : '2'}`;
                verseCard.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="font-orbitron font-bold text-xl ${isBot1 ? 'text-electric' : 'text-hot'}">${botName}</div>
                            <div class="text-xs text-slate-500 mt-1">Round ${currentRound}</div>
                        </div>
                        <div class="score-badge ${getScoreClass(verse.score)}">
                            ${verse.score}/10
                        </div>
                    </div>

                    <!-- Audio Player (Prominent) -->
                    <div id="audio-container-${verseId}" class="audio-container mb-4">
                        ${verse.audio_url && !verse.audio_url.startsWith('pending:') ? `
                            <div class="p-4 bg-deep/50 rounded-lg border border-${isBot1 ? 'electric' : 'hot'}/20">
                                <div class="flex items-center gap-4">
                                    <button onclick="toggleVerseAudio('${verseId}', '${verse.audio_url}')" class="verse-play-btn w-14 h-14 rounded-full bg-${isBot1 ? 'electric' : 'hot'}/20 hover:bg-${isBot1 ? 'electric' : 'hot'}/30 border-2 border-${isBot1 ? 'electric' : 'hot'}/50 flex items-center justify-center transition-all shadow-lg" id="btn-${verseId}">
                                        <svg class="w-6 h-6 text-${isBot1 ? 'electric' : 'hot'}" fill="currentColor" viewBox="0 0 24 24">
                                            <polygon points="8,5 19,12 8,19"/>
                                        </svg>
                                    </button>
                                    <div class="flex-1">
                                        <div class="text-sm font-bold text-${isBot1 ? 'electric' : 'hot'} mb-1">Audio Performance</div>
                                        <div class="flex gap-1" id="wave-${verseId}">
                                            ${Array(30).fill(0).map((_, i) => `<span style="height:${Math.random() * 20 + 6}px" class="inline-block w-1 bg-${isBot1 ? 'electric' : 'hot'}/40 rounded"></span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="p-4 bg-deep/50 rounded-lg border border-${isBot1 ? 'electric' : 'hot'}/20">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 rounded-full bg-${isBot1 ? 'electric' : 'hot'}/10 border-2 border-${isBot1 ? 'electric' : 'hot'}/30 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-${isBot1 ? 'electric' : 'hot'} animate-spin" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm text-${isBot1 ? 'electric' : 'hot'}/80">Generating audio performance...</div>
                                        <div class="text-xs text-slate-500 mt-1">This may take 30-60 seconds</div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>

                    <!-- Collapsible Lyrics -->
                    <div>
                        <button onclick="toggleLyrics('${verseId}')" class="text-sm text-slate-500 hover:text-slate-300 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                            View Lyrics
                        </button>
                        <div id="lyrics-${verseId}" class="hidden mt-3 p-4 bg-deep/30 rounded-lg border border-white/5">
                            <p class="text-slate-300 leading-relaxed whitespace-pre-wrap text-sm">${verse.verse_text}</p>
                        </div>
                    </div>
                `;

                container.appendChild(verseCard);

                // Animate verse appearance
                if (window.gsap) {
                    gsap.to(verseCard, {
                        opacity: 1,
                        y: 0,
                        duration: 0.6,
                        ease: 'power2.out'
                    });
                } else {
                    verseCard.style.opacity = 1;
                    verseCard.style.transform = 'translateY(0)';
                }

                // Generate audio if missing, or resume polling if pending
                if (!verse.audio_url) {
                    generateVerseAudio(verse.id, verseId, botName);
                } else if (verse.audio_url.startsWith('pending:')) {
                    pollAudioStatus(verse.id, verseId, botName);
                }

                // Wait between verses
                await delay(1000);
            }
        }

        async function loadNextRound() {
            // Disable button and show loading
            const btn = document.getElementById('next-round-btn');
            btn.disabled = true;
            btn.textContent = 'Generating Next Round...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const response = await fetch('/api/next-round', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ battle_id: battleData.id })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate next round');
                }

                const data = await response.json();

                // Reload battle data
                await loadBattle(battleData.id);

            } catch (error) {
                console.error('Error loading next round:', error);
                alert('Failed to generate next round. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Next Round ‚Üí';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        window.loadNextRound = loadNextRound;

        // Toggle DJ transcript visibility (using addEventListener for reliability)
        function setupDJTranscriptToggle() {
            const toggleBtn = document.getElementById('dj-transcript-toggle');
            const transcript = document.getElementById('dj-transcript');
            const toggleText = document.getElementById('dj-transcript-toggle-text');

            if (!toggleBtn || !transcript) return;

            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();

                if (transcript.classList.contains('hidden')) {
                    transcript.classList.remove('hidden');
                    toggleText.textContent = 'Hide Transcript ‚Üë';
                } else {
                    transcript.classList.add('hidden');
                    toggleText.textContent = 'View Transcript ‚Üì';
                }
            });
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', setupDJTranscriptToggle);

        // Toggle verse lyrics visibility
        window.toggleLyrics = function(verseId) {
            const lyrics = document.getElementById(`lyrics-${verseId}`);
            const button = lyrics.previousElementSibling;

            if (lyrics.classList.contains('hidden')) {
                lyrics.classList.remove('hidden');
                button.innerHTML = `
                    <svg class="w-4 h-4 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                    Hide Lyrics
                `;
            } else {
                lyrics.classList.add('hidden');
                button.innerHTML = `
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                    View Lyrics
                `;
            }
        };

        // DJ Claudius Audio Player
        let djAudio = null;
        let djCommentaryText = '';
        let useBrowserTTS = false;

        async function loadDJCommentaryAudio(battleId, commentary) {
            djCommentaryText = commentary;
            const audioFile = `/audio/dj-commentary-${battleId}.mp3`;

            // Check if pre-generated audio file exists
            try {
                const response = await fetch(audioFile, { method: 'HEAD' });
                if (response.ok) {
                    // Audio file exists! Use it
                    console.log('‚úÖ Found DJ Claudius audio:', audioFile);
                    useBrowserTTS = false;
                    setupDJAudioPlayer(audioFile);
                    return;
                }
            } catch (e) {
                console.log('No pre-generated audio, using browser TTS');
            }

            // Fall back to browser TTS
            useBrowserTTS = true;
            setupDJAudioPlayer(null);
        }

        function setupDJAudioPlayer(audioUrl) {
            const djAudioContainer = document.getElementById('dj-audio-container');

            djAudioContainer.innerHTML = `
                <div class="flex items-center gap-3">
                    <button onclick="toggleDJCommentary()" id="dj-play-btn" class="w-12 h-12 rounded-full bg-gold/20 hover:bg-gold/30 border-2 border-gold/50 flex items-center justify-center transition-all cursor-pointer">
                        <svg id="dj-play-icon" class="w-5 h-5 text-gold" fill="currentColor" viewBox="0 0 24 24">
                            <polygon points="8,5 19,12 8,19"/>
                        </svg>
                        <svg id="dj-pause-icon" class="w-5 h-5 text-gold hidden" fill="currentColor" viewBox="0 0 24 24">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>
                    </button>
                    <div class="flex-1">
                        <div class="text-sm font-bold text-gold mb-1">DJ Claudius Commentary</div>
                        <div class="text-xs text-gold/60">${audioUrl ? 'DJ Claudius Voice' : 'Browser Voice (run generate-all-dj-audio.sh for real voice)'}</div>
                    </div>
                </div>
            `;

            if (audioUrl) {
                // Pre-load the audio
                djAudio = new Audio(audioUrl);
                djAudio.preload = 'auto';
            }
        }

        window.toggleDJCommentary = function() {
            const playIcon = document.getElementById('dj-play-icon');
            const pauseIcon = document.getElementById('dj-pause-icon');

            if (useBrowserTTS) {
                // Use browser text-to-speech
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    return;
                }

                const speech = new SpeechSynthesisUtterance(djCommentaryText);
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v =>
                    v.name.includes('Daniel') || v.name.includes('Alex') ||
                    (v.lang.startsWith('en') && !v.name.includes('Female'))
                );
                if (preferredVoice) speech.voice = preferredVoice;
                speech.rate = 1.1;
                speech.pitch = 0.9;

                speech.onend = () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                };

                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                window.speechSynthesis.speak(speech);

            } else {
                // Use pre-generated audio file (DJ Claudius voice!)
                if (!djAudio) return;

                if (djAudio.paused) {
                    djAudio.play();
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                } else {
                    djAudio.pause();
                    djAudio.currentTime = 0;
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }

                djAudio.onended = () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                };
            }
        }

        async function showWinner(bot1Score, bot2Score) {
            const winnerSection = document.getElementById('winner-section');
            const winnerBanner = winnerSection.querySelector('.winner-banner');

            const winner = bot1Score > bot2Score ? bot1 : bot2;
            const loser = bot1Score > bot2Score ? bot2 : bot1;
            const isBot1Winner = bot1Score > bot2Score;

            document.getElementById('winner-name').textContent = winner.name;
            document.getElementById('final-score').textContent = `${bot1Score}-${bot2Score}`;

            // Calculate ELO changes (simplified K-factor of 32)
            const K = 32;
            const expectedBot1 = 1 / (1 + Math.pow(10, (bot2.elo_rating - bot1.elo_rating) / 400));
            const actualBot1 = isBot1Winner ? 1 : 0;
            const eloChangeBot1 = Math.round(K * (actualBot1 - expectedBot1));
            const eloChangeBot2 = -eloChangeBot1;

            // Update ELO display
            document.getElementById('bot1-name-elo').textContent = bot1.name;
            document.getElementById('bot2-name-elo').textContent = bot2.name;
            document.getElementById('bot1-elo-change').innerHTML = `
                <span class="${isBot1Winner ? 'text-acid' : 'text-electric'}">${bot1.elo_rating}</span>
                ‚Üí
                <span class="${isBot1Winner ? 'text-acid' : 'text-slate-400'}">${bot1.elo_rating + eloChangeBot1}</span>
                <span class="text-sm ${eloChangeBot1 > 0 ? 'text-green-400' : 'text-red-400'}">(${eloChangeBot1 > 0 ? '+' : ''}${eloChangeBot1})</span>
            `;
            document.getElementById('bot2-elo-change').innerHTML = `
                <span class="${isBot1Winner ? 'text-hot' : 'text-acid'}">${bot2.elo_rating}</span>
                ‚Üí
                <span class="${isBot1Winner ? 'text-slate-400' : 'text-acid'}">${bot2.elo_rating + eloChangeBot2}</span>
                <span class="text-sm ${eloChangeBot2 > 0 ? 'text-green-400' : 'text-red-400'}">(${eloChangeBot2 > 0 ? '+' : ''}${eloChangeBot2})</span>
            `;

            // Show winner section
            winnerSection.classList.remove('hidden');

            if (window.gsap) {
                gsap.to(winnerBanner, {
                    opacity: 1,
                    scale: 1,
                    duration: 0.8,
                    ease: 'back.out(1.7)'
                });
            } else {
                winnerBanner.style.opacity = 1;
                winnerBanner.style.transform = 'scale(1)';
            }

            // Confetti!
            if (window.confetti) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            // Update database with ELO changes and stats
            await updateBattleResults(winner.id, loser.id, eloChangeBot1, eloChangeBot2, isBot1Winner);
        }

        async function updateBattleResults(winnerId, loserId, eloChangeBot1, eloChangeBot2, isBot1Winner) {
            // NOTE: ELO and stats are already updated by the battle API
            // This function is kept for future use (e.g., analytics, notifications)
            // The battle API handles:
            // - Saving battle to database
            // - Updating bot ELO ratings
            // - Updating wins/losses
            // - Creating battle_verses records

            console.log('Battle results already saved by API:', {
                winnerId,
                bot1_elo_change: eloChangeBot1,
                bot2_elo_change: eloChangeBot2
            });
        }

        function getScoreClass(score) {
            if (score >= 8) return 'score-high';
            if (score >= 6) return 'score-medium';
            return 'score-low';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Generate audio for a verse on-demand (async with polling)
        async function generateVerseAudio(verseId, verseElementId, botName) {
            try {
                console.log(`üéµ Generating audio for ${botName} (verse ${verseId})...`);
                console.log(`   ‚Üí About to call /api/generate-audio with verse_id: ${verseId}`);

                // Step 1: Kick off audio generation (returns immediately)
                const response = await fetch('/api/generate-audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ verse_id: verseId })
                });

                console.log(`   ‚Üí Fetch completed! Status: ${response.status}`);

                if (!response.ok) {
                    console.error(`   ‚Üí Response not OK: ${response.status} ${response.statusText}`);
                    throw new Error('Audio generation request failed');
                }

                const data = await response.json();
                console.log(`   ‚Üí Response data:`, data);

                // If audio was already cached, show it immediately
                if (data.status === 'ready' && data.audio_url) {
                    showAudioPlayer(verseElementId, data.audio_url, botName);
                    return;
                }

                // Step 2: Poll /api/audio-status until ready
                if (data.status === 'processing') {
                    await pollAudioStatus(verseId, verseElementId, botName);
                    return;
                }

                throw new Error('Unexpected response from generate-audio');

            } catch (error) {
                console.error(`‚ùå Error generating audio for ${botName}:`, error);
                console.error(`   ‚Üí Error details:`, error.message, error.stack);
                showAudioError(verseElementId);
            }
        }

        // Poll the audio-status endpoint until the audio is ready
        async function pollAudioStatus(verseId, verseElementId, botName, retryCount = 0) {
            const MAX_POLLS = 60;        // Max number of polls
            const MAX_RETRIES = 2;       // Retry transient failures up to 2 times
            let pollDelay = 3000;        // Start with 3s, will increase to 10s

            for (let i = 0; i < MAX_POLLS; i++) {
                // Exponential backoff: 3s ‚Üí 5s ‚Üí 7s ‚Üí 10s (cap at 10s)
                if (i > 0) {
                    pollDelay = Math.min(10000, pollDelay + 2000);
                }

                await delay(pollDelay);

                try {
                    const response = await fetch(`/api/audio-status?verse_id=${verseId}`);
                    if (!response.ok) {
                        console.warn(`Audio status check failed (attempt ${i + 1}), status: ${response.status}`);
                        continue;
                    }

                    const data = await response.json();
                    console.log(`[Poll ${i + 1}] ${botName} audio status:`, data.status, data.prediction_status || '');

                    if (data.status === 'ready' && data.audio_url) {
                        console.log(`‚úÖ Audio ready for ${botName}:`, data.audio_url);
                        showAudioPlayer(verseElementId, data.audio_url, botName);
                        return;
                    }

                    if (data.status === 'failed') {
                        console.error('Audio generation failed:', data.error);

                        // Retry if error is retryable and we haven't exceeded max retries
                        if (data.retryable && retryCount < MAX_RETRIES) {
                            console.log(`Retrying audio generation (attempt ${retryCount + 1}/${MAX_RETRIES})...`);
                            await delay(2000);

                            // Regenerate the audio
                            try {
                                const regenResponse = await fetch('/api/generate-audio', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ verse_id: verseId })
                                });

                                if (regenResponse.ok) {
                                    const regenData = await regenResponse.json();
                                    if (regenData.status === 'processing') {
                                        // Start polling again with incremented retry count
                                        return pollAudioStatus(verseId, verseElementId, botName, retryCount + 1);
                                    }
                                }
                            } catch (regenError) {
                                console.error('Retry failed:', regenError);
                            }
                        }

                        showAudioError(verseElementId);
                        return;
                    }

                    // Still processing -- continue polling
                    if (data.status === 'processing') {
                        // Log less frequently to avoid console spam
                        if (i % 3 === 0 || i < 3) {
                            console.log(`‚è≥ Audio still generating for ${botName} (poll ${i + 1}, next in ${pollDelay/1000}s)...`);
                        }
                    }

                } catch (error) {
                    console.warn(`Audio status poll error (attempt ${i + 1}):`, error);
                    // Continue polling on network errors
                }
            }

            // Timed out
            console.error(`‚ùå Audio generation timed out after ${MAX_POLLS} polls (~${MAX_POLLS * 7}s)`);
            showAudioError(verseElementId, 'Audio generation timed out');
        }

        // Show the audio player UI for a verse
        function showAudioPlayer(verseElementId, audioUrl, botName) {
            const container = document.getElementById(`audio-container-${verseElementId}`);
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center gap-3 mt-3 pt-3 border-t border-white/5">
                        <button onclick="toggleVerseAudio('${verseElementId}', '${audioUrl}')" class="verse-play-btn w-10 h-10 rounded-full bg-electric/10 hover:bg-electric/20 border border-electric/30 flex items-center justify-center transition-all" id="btn-${verseElementId}">
                            <svg class="w-4 h-4 text-electric" fill="currentColor" viewBox="0 0 24 24">
                                <polygon points="5,3 19,12 5,21"/>
                            </svg>
                        </button>
                        <div class="flex-1">
                            <div class="text-xs text-slate-500 font-inter">Listen to verse</div>
                            <div class="flex gap-1 mt-1" id="wave-${verseElementId}">
                                ${Array(20).fill(0).map((_, i) => `<span style="height:${Math.random() * 12 + 4}px" class="inline-block w-0.5 bg-electric/30 rounded"></span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;

                console.log(`Audio ready for ${botName}`);
            }
        }

        // Show an error state for audio generation
        function showAudioError(verseElementId, message) {
            const container = document.getElementById(`audio-container-${verseElementId}`);
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center gap-3 mt-3 pt-3 border-t border-white/5">
                        <div class="w-10 h-10 rounded-full bg-red-500/10 border border-red-500/30 flex items-center justify-center">
                            <svg class="w-4 h-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-red-400 font-inter">${message || 'Audio generation failed'}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Audio player for verses
        let currentAudio = null;
        let currentButton = null;

        window.toggleVerseAudio = function(verseId, audioUrl) {
            const button = document.getElementById(`btn-${verseId}`);
            const icon = button.querySelector('svg');

            // If clicking the same verse, pause it
            if (currentAudio && currentButton === button) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                icon.innerHTML = '<polygon points="5,3 19,12 5,21"/>';
                currentAudio = null;
                currentButton = null;
                return;
            }

            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                if (currentButton) {
                    const prevIcon = currentButton.querySelector('svg');
                    prevIcon.innerHTML = '<polygon points="5,3 19,12 5,21"/>';
                }
            }

            // Play new audio
            const audio = new Audio(audioUrl);
            audio.play().catch(err => {
                console.error('Error playing audio:', err);
                alert('Failed to play audio. The file may not be ready yet.');
                icon.innerHTML = '<polygon points="5,3 19,12 5,21"/>';
            });

            // Update icon to pause
            icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';

            // When audio ends, reset button
            audio.onended = function() {
                icon.innerHTML = '<polygon points="5,3 19,12 5,21"/>';
                currentAudio = null;
                currentButton = null;
            };

            currentAudio = audio;
            currentButton = button;
        };
    </script>
</body>
</html>
