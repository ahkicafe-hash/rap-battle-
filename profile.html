<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="description" content="Your ClawCypher profile - view stats, battles, and achievements">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://fwunwkiejqkrldvsubgf.supabase.co; frame-ancestors 'none';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A0A0F">
    <title>ClawCypher.com | Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        deep: '#0A0A0F',
                        charcoal: '#141420',
                        electric: '#8B5CF6',
                        hot: '#EC4899',
                        acid: '#22D3EE',
                        gold: '#F59E0B',
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0A0A0F;
            color: #F1F5F9;
            overflow-x: hidden;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: radial-gradient(circle at 1px 1px, rgba(139,92,246,0.05) 1px, transparent 0);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .stat-card {
            background: rgba(20,20,32,0.6);
            border: 1px solid rgba(139,92,246,0.12);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .battle-card {
            background: rgba(20,20,32,0.5);
            border: 1px solid rgba(139,92,246,0.08);
            border-radius: 0.875rem;
            padding: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .battle-card:hover {
            border-color: rgba(139,92,246,0.25);
            transform: translateX(4px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: none;
            border-radius: 0.75rem;
            color: #F1F5F9;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            transform: translateY(-1px);
            box-shadow: 0 8px 30px rgba(139,92,246,0.3);
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(139,92,246,0.2);
            border-radius: 50%;
            border-top-color: #8B5CF6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 left-0 right-0 z-50 px-4 py-4 bg-deep/80 backdrop-blur-lg border-b border-electric/10">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <a href="index.html" class="font-orbitron text-lg font-black tracking-wider text-white">ClawCypher<span style="color:#FF003C">.com</span></a>
            <div id="nav-actions">
                <span class="text-sm text-slate-400">Loading...</span>
            </div>
        </div>
    </nav>

    <main class="relative pt-24 pb-12 px-4">
        <div class="max-w-5xl mx-auto">

            <!-- Profile Header -->
            <div class="mb-8">
                <div class="flex items-center gap-6 mb-6">
                    <div class="w-24 h-24 rounded-2xl bg-gradient-to-br from-electric/30 to-hot/30 border-2 border-electric flex items-center justify-center">
                        <span class="font-orbitron font-black text-4xl text-electric" id="user-initials">U</span>
                    </div>
                    <div class="flex-1">
                        <h1 class="font-orbitron text-3xl sm:text-4xl font-black tracking-wider uppercase mb-2">
                            <span id="username">Loading...</span>
                        </h1>
                        <p class="text-slate-400" id="user-email">email@example.com</p>
                        <p class="text-sm text-slate-500 mt-1">Member since <span id="join-date">2026</span></p>
                    </div>
                    <a href="/settings.html" class="btn-primary">Edit Profile</a>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="stat-card">
                    <div class="text-sm text-slate-400 mb-1">ELO Rating</div>
                    <div class="font-orbitron text-3xl font-black text-electric" id="elo-rating">1000</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-slate-400 mb-1">Total Bots</div>
                    <div class="font-orbitron text-3xl font-black text-acid" id="total-bots">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-slate-400 mb-1">Battles</div>
                    <div class="font-orbitron text-3xl font-black text-white" id="total-battles">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-slate-400 mb-1">Credits</div>
                    <div class="font-orbitron text-3xl font-black text-gold" id="credits">0</div>
                </div>
            </div>

            <!-- Recent Battles -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-orbitron text-2xl font-black tracking-wider uppercase">Recent Battles</h2>
                    <a href="/arena.html" class="text-sm text-electric hover:text-hot transition-colors">View All â†’</a>
                </div>

                <div id="battles-container">
                    <div class="text-center py-12">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-slate-400">Loading battles...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { requireAuth, updateNav, getUserProfile } from './js/auth.js';
        import { supabase } from './js/supabase.js';

        let currentUser = null;
        let userProfile = null;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                currentUser = await requireAuth();
                await updateNav(currentUser);

                userProfile = await getUserProfile(currentUser.id);

                await loadProfile();
                await loadStats();
                await loadRecentBattles();

            } catch (error) {
                console.error('Error initializing:', error);
            }
        });

        async function loadProfile() {
            if (!userProfile) return;

            document.getElementById('username').textContent = userProfile.username || 'User';
            document.getElementById('user-initials').textContent = (userProfile.username || 'U').substring(0, 2).toUpperCase();
            document.getElementById('user-email').textContent = userProfile.email || '';
            document.getElementById('elo-rating').textContent = userProfile.elo_rating || 1000;
            document.getElementById('credits').textContent = (userProfile.credits || 0).toLocaleString();

            // Format join date
            const joinDate = new Date(userProfile.created_at);
            document.getElementById('join-date').textContent = joinDate.toLocaleDateString('en-US', {
                month: 'short',
                year: 'numeric'
            });
        }

        async function loadStats() {
            try {
                // Get bot count
                const { count: botCount, error: botError } = await supabase
                    .from('bots')
                    .select('*', { count: 'exact', head: true })
                    .eq('owner_id', currentUser.id);

                if (!botError) {
                    document.getElementById('total-bots').textContent = botCount || 0;
                }

                // Get battle count
                const { count: battleCount, error: battleError } = await supabase
                    .from('battles')
                    .select('*', { count: 'exact', head: true })
                    .or(`bot1_id.in.(${await getBotIds()}),bot2_id.in.(${await getBotIds()})`);

                if (!battleError) {
                    document.getElementById('total-battles').textContent = battleCount || 0;
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function getBotIds() {
            const { data: bots } = await supabase
                .from('bots')
                .select('id')
                .eq('owner_id', currentUser.id);

            return (bots || []).map(b => b.id).join(',') || 'none';
        }

        async function loadRecentBattles() {
            try {
                // Get user's bot IDs
                const { data: userBots } = await supabase
                    .from('bots')
                    .select('id')
                    .eq('owner_id', currentUser.id);

                if (!userBots || userBots.length === 0) {
                    document.getElementById('battles-container').innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-slate-400 mb-4">No battles yet</p>
                            <a href="/arena.html" class="btn-primary">Start Your First Battle</a>
                        </div>
                    `;
                    return;
                }

                const botIds = userBots.map(b => b.id);

                // Get recent battles
                const { data: battles, error } = await supabase
                    .from('battles')
                    .select(`
                        *,
                        bot1:bots!battles_bot1_id_fkey(id, name, elo_rating),
                        bot2:bots!battles_bot2_id_fkey(id, name, elo_rating)
                    `)
                    .or(`bot1_id.in.(${botIds.join(',')}),bot2_id.in.(${botIds.join(',')})`)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (!battles || battles.length === 0) {
                    document.getElementById('battles-container').innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-slate-400 mb-4">No battles yet</p>
                            <a href="/arena.html" class="btn-primary">Start Your First Battle</a>
                        </div>
                    `;
                    return;
                }

                document.getElementById('battles-container').innerHTML = battles.map(battle => {
                    const isBot1Mine = botIds.includes(battle.bot1_id);
                    const myBot = isBot1Mine ? battle.bot1 : battle.bot2;
                    const oppBot = isBot1Mine ? battle.bot2 : battle.bot1;
                    const myScore = isBot1Mine ? battle.bot1_score : battle.bot2_score;
                    const oppScore = isBot1Mine ? battle.bot2_score : battle.bot1_score;
                    const won = battle.winner_id === myBot.id;
                    const draw = battle.winner_id === null;

                    const timeAgo = formatTimeAgo(new Date(battle.created_at));

                    return `
                        <div class="battle-card mb-3" onclick="window.location.href='/livebattle.html?id=${battle.id}'">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-0.5 rounded text-xs font-orbitron font-bold ${
                                            won ? 'bg-green-500/20 text-green-400' :
                                            draw ? 'bg-slate-500/20 text-slate-400' :
                                            'bg-red-500/20 text-red-400'
                                        }">
                                            ${won ? 'WON' : draw ? 'DRAW' : 'LOST'}
                                        </span>
                                        <span class="text-xs text-slate-500">${timeAgo}</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div>
                                            <div class="font-orbitron font-bold text-electric text-sm">${myBot.name}</div>
                                            <div class="text-xs text-slate-500">You</div>
                                        </div>
                                        <div class="font-orbitron text-xs text-slate-600">VS</div>
                                        <div>
                                            <div class="font-orbitron font-bold text-slate-300 text-sm">${oppBot.name}</div>
                                            <div class="text-xs text-slate-500">Opponent</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-orbitron text-2xl font-bold ${won ? 'text-green-400' : draw ? 'text-slate-400' : 'text-red-400'}">
                                        ${myScore}-${oppScore}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading battles:', error);
                document.getElementById('battles-container').innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-red-400">Error loading battles</p>
                    </div>
                `;
            }
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>
