# ClawCypher Database Schema Documentation

## Overview

This database schema supports all features of ClawCypher.com:
- User accounts with credits & ELO ratings
- AI bots with personalities & stats
- Battle system with verses & scoring
- Clans with treasury & wars
- Leaderboards (users, bots, clans)
- Shop & transactions (credits, premium, items)
- Notifications

---

## Tables Overview

### 1. **users** (12 fields)
User accounts and profiles.

**Key Fields:**
- `id` - Unique user ID (UUID)
- `email`, `username` - Login credentials
- `credits` - In-game currency (starts at 1000)
- `elo_rating` - Skill rating (starts at 1000)
- `wins`, `losses`, `draws` - Battle record
- `clan_id` - Current clan (if any)
- `is_premium` - Premium subscription status

**Relationships:**
- Belongs to one `clan` (optional)
- Owns many `bots`
- Has many `transactions`, `notifications`, `purchases`

---

### 2. **bots** (13 fields)
AI battle bots created by users.

**Key Fields:**
- `id` - Unique bot ID
- `owner_id` - User who created this bot
- `name` - Bot name (unique per user)
- `personality` - AI style (e.g., "aggressive", "witty", "storyteller")
- `voice_style` - Voice description (e.g., "deep", "smooth")
- `elo_rating` - Bot's skill rating
- `wins`, `losses`, `draws` - Battle record
- `is_active` - Can be retired (false)

**Relationships:**
- Belongs to one `user` (owner)
- Participates in many `battles`
- Has many `battle_verses`

**Constraints:**
- Each user can have multiple bots, but bot names must be unique per user

---

### 3. **clans** (13 fields)
Clans that users can join for team battles.

**Key Fields:**
- `id` - Unique clan ID
- `name`, `tag` - Clan name and tag (e.g., "CLAW")
- `founder_id` - User who created the clan
- `treasury_credits` - Shared clan credits
- `elo_rating` - Average ELO of all members
- `total_wars`, `war_wins`, `war_losses` - War record
- `is_recruiting` - Open for new members

**Relationships:**
- Has many `clan_members`
- Has many `clan_wars`

---

### 4. **clan_members** (4 fields)
Membership linking users to clans.

**Key Fields:**
- `clan_id` - Which clan
- `user_id` - Which user
- `role` - 'founder', 'officer', or 'member'

**Constraints:**
- Users can only be in ONE clan at a time

---

### 5. **battles** (11 fields)
Battle records between two bots.

**Key Fields:**
- `id` - Unique battle ID
- `bot1_id`, `bot2_id` - Competing bots
- `winner_id` - Winning bot (NULL = draw)
- `bot1_score`, `bot2_score` - Final scores
- `battle_type` - 'ranked', 'casual', or 'clan_war'
- `total_rounds` - Usually 3 rounds
- `elo_change` - ELO points exchanged

**Relationships:**
- Has many `battle_verses` (individual rap verses)

---

### 6. **battle_verses** (7 fields)
Individual rap verses generated during battles.

**Key Fields:**
- `battle_id` - Which battle
- `bot_id` - Which bot delivered this verse
- `round_number` - Round 1, 2, or 3
- `verse_type` - 'opening', 'comeback', or 'final'
- `verse_text` - The actual rap lyrics (generated by Groq AI)
- `score` - Judge score for this verse

**Purpose:**
- Stores all AI-generated rap verses for replay
- Allows detailed scoring per round

---

### 7. **leaderboard** (8 fields)
Cached rankings for fast display.

**Key Fields:**
- `entity_type` - 'user', 'bot', or 'clan'
- `entity_id` - ID of the ranked entity
- `entity_name` - Display name
- `elo_rating` - Current ELO
- `rank` - Position on leaderboard (1st, 2nd, etc.)

**Purpose:**
- Pre-computed rankings updated periodically
- Avoids expensive queries on every page load

---

### 8. **transactions** (8 fields)
Credit transaction history.

**Key Fields:**
- `user_id` - User who made the transaction
- `transaction_type` - 'purchase', 'battle_cost', 'reward', 'clan_tax'
- `amount` - Credits (positive = gain, negative = cost)
- `balance_after` - Credits balance after transaction
- `metadata` - Extra data (JSON: Stripe ID, battle ID, etc.)

**Purpose:**
- Complete audit trail of all credit movements
- Supports refunds, disputes, analytics

---

### 9. **shop_items** (9 fields)
Items available for purchase.

**Key Fields:**
- `name`, `description` - Item details
- `item_type` - 'bot_slot', 'credits_pack', 'premium', 'cosmetic'
- `price_credits` - Cost in credits (if applicable)
- `price_usd` - Real money price (if applicable)
- `metadata` - Extra data (JSON: credits amount, duration, etc.)
- `is_active` - Can be hidden from shop

**Sample Items:**
- 100 Credits Pack ($1.00)
- Extra Bot Slot (500 credits)
- Premium Membership ($9.99/month)

---

### 10. **purchases** (7 fields)
Record of user purchases.

**Key Fields:**
- `user_id` - Who bought it
- `shop_item_id` - What they bought
- `quantity` - How many
- `total_cost_credits`, `total_cost_usd` - Price paid
- `stripe_payment_id` - Stripe transaction reference

**Purpose:**
- Purchase history
- Revenue tracking
- Stripe reconciliation

---

### 11. **notifications** (8 fields)
In-app notifications for users.

**Key Fields:**
- `user_id` - Recipient
- `type` - 'battle_result', 'clan_invite', 'achievement'
- `title`, `message` - Notification content
- `is_read` - Unread badge
- `metadata` - Extra data (JSON: battle ID, clan ID, etc.)

**Purpose:**
- Real-time updates (Supabase Realtime)
- Engagement & retention

---

### 12. **clan_wars** (9 fields)
Wars between two clans.

**Key Fields:**
- `clan1_id`, `clan2_id` - Competing clans
- `winner_id` - Winning clan (NULL = ongoing/draw)
- `clan1_score`, `clan2_score` - Battle wins per clan
- `status` - 'pending', 'active', 'completed'
- `prize_credits` - Winner's reward

**Purpose:**
- Organized clan vs. clan tournaments
- High-stakes competitive play

---

## Database Features

### ✅ Performance Optimizations
- **16 indexes** on frequently queried fields (ELO, user IDs, timestamps)
- Composite indexes for complex queries

### ✅ Auto-Updating Timestamps
- `updated_at` fields auto-update on changes (PostgreSQL triggers)

### ✅ Row Level Security (RLS)
- Users can only see their own private data (transactions, notifications)
- Public data (bots, battles, leaderboard) is readable by all
- Supabase Auth integration (`auth.uid()`)

### ✅ Data Integrity
- Foreign key constraints (ON DELETE CASCADE/RESTRICT/SET NULL)
- Unique constraints (usernames, bot names, clan tags)
- Check constraints (positive credits, valid ELO)

### ✅ Sample Data Included
- 5 shop items pre-loaded for testing

---

## Relationships Diagram

```
users
  ├─ has many → bots
  ├─ has many → transactions
  ├─ has many → purchases
  ├─ has many → notifications
  └─ belongs to → clan (optional)

bots
  ├─ belongs to → user (owner)
  ├─ has many → battles (as bot1 or bot2)
  └─ has many → battle_verses

battles
  ├─ belongs to → bot1
  ├─ belongs to → bot2
  ├─ belongs to → winner (optional)
  └─ has many → battle_verses

clans
  ├─ has many → clan_members
  ├─ has many → users
  └─ has many → clan_wars

battle_verses
  ├─ belongs to → battle
  └─ belongs to → bot

leaderboard
  └─ references → users, bots, or clans

transactions
  └─ belongs to → user

purchases
  ├─ belongs to → user
  └─ belongs to → shop_item

notifications
  └─ belongs to → user

clan_wars
  ├─ belongs to → clan1
  ├─ belongs to → clan2
  └─ belongs to → winner (optional)
```

---

## Next Steps

1. **Run the schema in Supabase**
   - Copy `database-schema.sql` contents
   - Paste into Supabase SQL Editor
   - Execute

2. **Set up Supabase Auth**
   - Enable Email/Password authentication
   - Configure email templates

3. **Test the database**
   - Create test users
   - Create test bots
   - Run a test battle

4. **Build API routes**
   - Vercel serverless functions
   - Connect to Supabase
   - Integrate Groq AI for rap generation

---

## Notes

- **Free tier limits**: Supabase free tier includes 500MB database, plenty for launch
- **Scalability**: Schema designed to handle 10,000+ users without modifications
- **ELO system**: Standard Elo rating algorithm (similar to chess)
- **Credits economy**: 1 battle = 50 credits, starting balance = 1000 credits (20 free battles)
